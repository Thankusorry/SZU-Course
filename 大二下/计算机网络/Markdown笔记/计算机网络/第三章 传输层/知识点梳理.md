## 传输层
介于应用层和网络层之间，作用是端到端(进程到进程之间可靠的通信)
进程唯一标识：三元组（源端口，目的端口，协议）
进程间通信标识：五元组（源端口，目的端口，源IP，目的IP，协议）
端口号：熟知端口号，注册端口号和临时端口号（边界65535）
传输层的基本功能：复用/分解和差错检验
两个传输层协议：TCP vs UDP 
1.可靠性：TCP可靠，UDP不可靠
2.连接：TCP面向连接，UDP不连接
3.报文：TCP面向字节流，UDP面向报文
4.机制：TCP有流量控制和拥塞控制和重传机制，UDP尽力而为
5.速率和开销：TCP慢且开销大，UDP快，开销小，因此两个使用场景不同

## UDP
特点：无连接，不可靠，**支持广播**
UDP头部8字节： 2 2 2 2 源端口，目的端口，UDP总长度，校验和
UDP总长度包含头部和数据
校验和UDP是可选的，校验和=伪首部+UDP首部+应用层数据
伪首部：44112 源IP，目的IP，保留，协议号（UDP 17 TCP 6），UDP总长度
**伪首部是临时的，借助网络层的信息，不会随报头传输**
UDP仅有两个功能对应传输层最低提供的功能

## TCP
特点：面向连接，字节流，三个机制，**全双工，不支持广播**
TCP报头：20B固定长度+40B选项和填充
源端口 目的端口 4 发送序号 4 确认序号 4 
4bit TCP总长度：以4字节为单位，范围是5-15，对应20-60，**不包含数据**
6bit 保留全零
6bit 控制字段 **2ACK 5SYN 6FIN**
窗口值 2B：能接受的数据总大小
校验和 2B ：计算方式和UDP一样，也需要伪首部，对应协议号6，TCP校验和必选
紧急指针 2B

常考的是发送序号和确认序号，一般发送序号=接受的确认序号，确认序号=接收的发送序号+数据长度
特殊情况：建立连接和释放连接，确认序号=接收的发送序号+1 ack=u+1

三次握手：SYN=1，ACK=0请求连接 seq=x 
SYN=1，ACK=1确认连接 seq=y,ack=x+1
确认 确认连接 ACK=1，seq=x+1,ack=y+1
**保持/保活计时器：防止两个TCP连接出现长时间的空闲**
开始传输数据

四次挥手：任意一方都能关闭连接
FIN=1请求释放连接 seq=u
ACK=1 确认释放连接 seq=v,ack=u+1
传输完数据后，请求释放连接 FIN=1,seq=w,ack=u+1
确认释放连接 ACK=1 seq=u+1,ack=w+1
等待2MSL——时间等待计时器
作用：1.**确认最后的ACK报文能够到达**，使双方都释放连接，
2.防止旧连接干扰新链接：2MSL保证所有旧连接的报文失效，避免旧连接报文干扰新连接的数据

三个机制：
窗口形式：滑动窗口
发送窗口按接收数据分为：
1. 已发送且已确认
2. 已发送未确认
3. 未发送但准备发送
4. 未发送且不准备发送
重传机制：
1.超时重传：只要有报文就会触发 **重传计时器**
2.确认重传：根据ACK的反馈来重传
1）快重传：连续收到3个重复的ACK确认报文立即重传
重传的方式：GBN/SACK
确认重传一般快于超时重传

滑动窗口协议：用来解决**流量控制**

流量控制：接收方通过窗口控制发送方的发送速率
**只和接收方的缓存有关**
零窗口：告诉发送方缓存满了，不要发数据了
窗口更新：告诉发送方我接受了多少数据，还剩多少缓存
**坚持定时器：防止发送方收到零窗口后接收方发送窗口更新丢失导致双方都陷入等待的死锁状态**
发送方发送窗口探测询问接收方还剩多少窗口值

拥塞控制
**三个窗口关系：发送窗口，通知窗口rwnd，拥塞窗口cwnd**
发送窗口=min(rwnd，cwnd)
rwnd唯一取决于接收方缓存
cwnd是发送方根据网络拥塞状况得出窗口值
MSS：最大报文段长度
**==慢开始：从MSS开始指数级递增，最后到SST慢开始阙值==**
进入拥塞避免：k=1线性递增直到发生拥塞
拥塞判定：
1. 超时——重新从慢开始阶段开始
2. 三次重复的ACK确认——从cwnd减半开始
发生拥塞：执行**快重传**

### **MSS错题**
==**拥塞窗口增长幅度也是也MSS为单位，当MSS=2KB/else，注意不要掉进坑里**==

甲和乙**刚建立 TCP 连接**，并约定==**最大段长度为2KB**==，假设乙总是及时清空缓存，保证接收窗口始终为20KB。**初始ssthresh设置为16KB**。**若双向传输时间为10ms**，发送时延忽略不计，且没有发生拥塞的情况，则经过（ ）甲的发送窗口第一次达到20KB

刚建立连接——cwnd从1MSS开始：2KB
MSS=2KB——错误点在于 ==**拥塞避免阶段线性增长的速度是MSS**==
即 2->4->8->**16->18->20** ——**只需要5RTT**