## 2个缓存、2个窗口（控制字节流传输过程）
 · **发送方缓存**：用于存储准备发送的数据
 · **发送窗口**：窗口值不为0，可以发送报文段
 · **接收方缓存**：将正确接收的字节流写入缓存，等待接收读取
 · **接收窗口**：窗口值等于接收缓存可以接收的字节流
<u>每一个进程都有这两个窗口(既可以发送方，也可以是接收方)<u></u></u>
**==窗口的形式为滑动窗口==**
**滑动窗口的特点：**
1. 使用**发送和接受缓冲区** --> 控制字节流传输
2. 可以**差错控制和流量控制**
3. 接收方可以在任何时候发送确认，窗口大小可由接收方根据需要增大或减少
4. **发送窗口值不能超过接收窗口值**
## 发送窗口
**通过滑动窗口跟踪、记录发送状态，实现差错控制**
按顺序分为四类，**==窗口向左移动==**
1. **已发送且被确认——发送窗口右边界**
2. **已发送未被确认——==已发送窗口==**
3. **未发送但被确认——==可用窗口==**
4. **未发送未被确认——发送窗口左边界**
**==发送窗口=已发送窗口+可用窗口=窗口大小==**

**==窗口移动一定是受到新的确认,并且这个确认对应窗口未被确认的边界元素==**
发送窗口的大小由两个方面控制： 
1. 接收缓存大小（**接收方窗口值**）
2. 整体网络的拥塞状况（**拥塞控制**）
**==发送窗口=min(通知窗口，拥塞窗口)==**
![[发送窗口.png]]
# 重传
**一般来说，分为确认重传和超时重传**
## 确认重传机制
**根据接收方的确认ACK报文来判断是否重传**
![[tcp.png]]

### **Overall**
**假设：A向B发送了一个报文段，覆盖字节编号[1,6]，A收到B的确认号是4，窗口大小为6B
因此下一次B期望接收的字节在范围[i,j]之内**
- 若收到的字节的序号 **<=3**，则是 **==重复的数据，丢弃==**
- 序号 **>=10**，则是==**跳序的数据，丢弃**==

### **1.GBN(Go-back-N) 回退方式**
收到确认序号为2，重发2之后所有报文（**取决于窗口长度**）
- 效率低
### **2.Select Acknowledgment SACK 选择重发**
**发送方只需重发窗口内丢失的报文段，而不需要重发已经接收的报文段**
### **3.Fast Retransmit 快速重传**
发送方**连续收到 ​3 个重复的 ACK​（Dup-ACK）**，表明某个数据包可能丢失，**立即重传**该包而无需等待超时。
## 超时重传机制
**=="可靠的保底机制"==**
**重传定时器：处理报文确认与等待重传的时间。发送一个报文，将其副本放入重传队列**
——**只要是发送报文，都会触发重传计时器**
![[超时重传示意图.png]]
### **重传时间 Timeout**
- 太短：**很多报文段不必要的重传**，使网络负荷增大
- 太长：**占用带宽**，降低传输效率，比如一个报文已经丢失，而发送方长时间等待
**==——根据实际的RTT动态调整==**

**旧RTT=上一个报文估算的RTT**
**最新RTT测量值=上一个报文实际的RTT**

![[Timeout and rtt.png|675]]
**==思想==**：每收到一个RTT都按照公式进行计算 `RTT1=α×RTT0+(1-α)×SampleRTT1`
**收到N个确认报文段后，RTT估算值的一般表达式为**
![[RTT.png|525]]
==**缺点： TCP协议具有二义性**==
	**没有定义重传的报文段与原先的报文段的差别，故而在测量RTT时，无法确定将一个确认(ACK)与第几个重传关联**
### **考点**
1.**确认号的理解——报文丢失**
如果A连续发送多个报文，B只收到若干个,则B->A的确认号是A序列中第一个丢失报文的序号
**第一个丢失报文后续发送报文处理：窗口不会移动**
- GBN：丢弃，SACK：确认在窗口内的报文

2.和快重传有所区别

[[四个定时器]]
# 错题

TCP中的滑动窗口协议用来解决（ ）
- 端到端的流量控制
TCP采用超时重发的差错控制技术，超时重传时间的设置是根据（ ）来定的
- 历史往返时间和最新获得的往返时间
主机A与主机B己建立一个TCP连接，主机A向主机B发送了两个连续的TCP段，分别包含200字节和400字节的有效载荷，第一个段的序号为300，主机B正确接收到两个段后，发送给主机的确认序号是（ ）
- 900
在滑动窗口流量控制中，若窗口大小为16，则ack=9意味着接收方期待的下一字节是（  ）号字节
- 9
### **大题**
**A向B连续发送两个报文：**
假设这两个报文顺序到达B，**第一个确认丢失了，第二个确认正常到达A**，请问主机A在什么情况下会进行重传，并指出重传哪个报文？而在什么情况下不进行重传？

==**考察：确认重传和超时重传**==

**仅当第二个确认号在第一个报文的重传定时器过期之后到达，发生重传，重传第一个报文**