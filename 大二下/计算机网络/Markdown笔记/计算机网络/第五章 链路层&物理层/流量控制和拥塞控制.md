# 流量控制
## 缘由
**控制发送方**： 发送能力不能超过接受能力，否则出现丢包

==**链路层协议：**==
1. **单帧停止等待协议**
2. **连续发送ARQ协议**： 拉回重发协议和选择重发协议SACK
3. **滑动窗口协议**

## 单帧停止等待协议
发送方每次发送一帧后，需要等待确认帧返回，再发送下一帧
**确认帧ACK or 否定帧NAK**
- 协议简单，但传输效率低下

![[单帧停止等待协议.png]]

### **考点：计算时延**
![[单帧停止等待时延.png|600]]
**单帧停止等待 流程：**
1. 发送方 发送帧 —— **传播延时 tp = 链路长度 / 电磁波传播速率**
2. 发送方 传输帧 —— **帧传输延时 tf = 帧大小/ 网口传输速率  bit / bps**
3. 接收方 处理帧 —— **处理延时 tpr**
4. 接收方 发送确认帧 —— **传播延时 tp + 传输延时 ta**
5. 发送方 处理确认帧 —— **处理延时tpr**

**帧传输总耗时 T = 2tp+2pr+tf+ta**
- <font color="#00b050">处理延时 tpr 和 确认帧发送 ta 较小 可忽略</font>
==**tT ≈tf+2tp**==

**==帧传输效率U==** =  数据帧传输延时 / 总延时 = tf / T
	U=tf/tT=tf /(tf+2tp)
	tp一般链路确定，固定不变
**帧越大，效率越高**，但**MTU限制帧大小**

==**坑： 两倍传播时延实际上就是RTT**==

信道吞吐率/信道传输速率（吞吐量）= **帧大小 / T**
## 连续ARQ协议
ARQ： Automatic Repeat reQuest
发送方向接收方 **==连续发送数据帧==** ，接收方对收到的数据帧进行校验后，向发送方返回相应的==**应答帧（ACK or NAK)**==

### **拉回重发GBN**
**==累计确认==**：某一数据帧的确认即表明该数据帧及这以前所有的数据帧均已正确接收

#### **例子：收到xx的确认，需要重发哪些？**
数据链路层采用后退N帧（GBN）协议，**发送方已经发送了编号为0~7的帧**。当计时器超时时，若**发送方只接收到0、2、3号帧的确认**，则发送方需要重发的帧数是 **_4_**
	收到3: 包括3之前都收到了
	重发 ： 4、5、6、7

### **选择重传SR**
**重传情况：**
1. 发送方缓冲区，**==计时器超时重传==**
2. 接收方怀疑帧出错，发送否定帧NAK，==**重传NAK中指定的帧**==

#### **例子**
数据链路层采用选择重传协议（SR）传输数据，**发送方已经发送了0~3号数据帧**，现已经**收到1号帧的确认**，而0,2号帧依次超时，则此时需要重传的帧数是
	1号帧的确认：仅代表1号帧
	**需要重传：0,2**
为什么4不需要重传？—— ==**选择重传只重传“确实丢失的帧(NAK)”**==
	4 等待ACK或者超时
## 滑动窗口协议
1. 所有帧都有**编号**——**序列号**
2. 序列号是**有限位数的二进制数**，会**循环使用**
3. 链路层的滑动窗口大小指的是**帧的数量**，和TCP的字节数据不同

==**设置发送窗口Ws**==：对发送方进行流量控制（Ws代表在还没有收到接收方确认信息的情况下发送方最多可以发送的数据帧数）
	**特例：当Ws=1，效果就是单帧停止等待协议**
### **GBN滑动窗口：**
发送方最多可以**连续发送** `N` 个未被确认的帧——N对应窗口大小

==**窗口大小和序列号长度的对应关系：**==
	==**序号个数 ≥ 窗口大小 + 1**==
#### **旧帧混淆成新帧例子：**
假设：
- **发送窗口大小 = 8**
- 序列号只有 **3 位** ⇒ 编号空间是 `0~7`（共 8 个编号）
发送方最开始会发送帧编号为：
`0, 1, 2, 3, 4, 5, 6, 7   ✅ 这是第一轮帧`
如果发送方**没有等确认**，又继续发……
	因为序列号只有 `0~7`，**继续发时就只能再从 0 开始**：
`0, 1, 2, 3, 4, 5, 6, 7   ← 第二轮帧（新帧，但编号与上一轮一样）`
**矛盾**：假如收到一个零号帧，无法判断第一轮里丢失的0帧还是第二轮里刚刚发的新0帧

##### **练习**
数据链路层**采用了后退N帧的（GBN）协议**，如果**发送窗口的大小是32**，那么至少需要（ ）位的序列号才能保证协议不出错 **_6_**

### 选择重传
==**发送窗口和接收窗口尺寸之和不能超过整个序号空间N**==
## 考点1（重点）：计算信道利用率 or 吞吐量
### **例子**
**信道速率 10Mbps, RTT=80ms，帧大小 1Mb——tf=100ms**
**假设窗口大小=3**
- 单帧停等
**U=tf/tT, T=F/tT**
- 连续ARQ
**U=100%, T=10Mbps**
	在第二个帧传输结束前，已经收到第一个帧的确认，因此，在一个帧的周期中，全部时间都用来传输帧

**另一种情况**：RTT=600ms
tT=rtt+tf=700ms

**本质就是在收到第一个帧的确认前(RTT)最多能发几个帧——取决于窗口大小**

**因此，当窗口大小 >= [tT/tf] (向上取整)，信道利用率达到100%**

==**所以，单帧停等协议是连续ARQ 窗口大小=1 的特例**==

### 练习1：
一个信道的**数据传输速率为4 Kb/s**，**单向传播时延为30 ms**。若要使**单帧停等协议**的
**信道最大利用率达到80%**，则要求的数据帧长至少

tf=F/v = F/4000 | tT = tf+RTT 
U=tf/tT=0.8
**—— F=960bit**

